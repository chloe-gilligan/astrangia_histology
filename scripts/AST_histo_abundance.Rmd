---
title: "AST_histo_abundance"
author: "Chlo√© Gilligan"
date: "2025-07-31"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:


```{r}
install.packages("ggpubr")
install.packages("tidyverse")
install.packages("coin")
library(coin)
library(tidyverse)
library("RColorBrewer")
library(ggpubr)
```

## Reading in data and metadata
```{r}
library(readr)
##data <- read_csv("../data/astrangia_histology_abundance.csv", col_names = TRUE, na = c("", "NA")) %>%
##select(full_sample_id, timepoint, treatment, date, species, month, site,  sex, StageI, StageII, StageIII, StageIV, StageV)

data <- read_csv("../data/astrangia_histology_abundance.csv",
                 col_names = TRUE, 
                 na = c("", "NA")) %>%
  select(full_sample_id, timepoint, treatment, date, species, month, site, sex, 
         StageI, StageII, StageIII, StageIV, StageV)


```


## Separating the "TP" from sample ID's the begin with AST, keeping them on the field samples
```{r}
library(dplyr)

data <- data %>%
  mutate(full_sample_id = ifelse(
    startsWith(full_sample_id, "AST"),
    gsub("TP", "", full_sample_id),
    full_sample_id
  ))
```

#calculate the total number of gametes in a sample
```{r}

data <- data %>%
rowwise() %>%
mutate(total.gametes = sum(StageI,StageII,StageIII,StageIV,StageV,na.rm = T))

```

# assign a value of Stage 0 to samples with no gametes
#if = if total.gametes = 0, then add a value of 1 to a new column called "Stage0"
#else = if total.gamates > 0, then add a value of 0 to a new column called "Stage0"
```{r}
data <- data %>%
  mutate(Stage0 = ifelse(total.gametes==0, 1, 0))
```

#calculate relative abundance of stage by sex, timepoint, treatment
```{r}
Rel.Abundance <- data %>%
  group_by(sex, timepoint, treatment, date) %>%
  summarise(
    total_gametes = sum(total.gametes, na.rm = TRUE),
    StageI = sum(StageI, na.rm = TRUE),
    StageII = sum(StageII, na.rm = TRUE),
    StageIII = sum(StageIII, na.rm = TRUE),
    StageIV = sum(StageIV, na.rm = TRUE),
    StageV = sum(StageV, na.rm = TRUE)
  ) %>%
  mutate(
    rel_abundance_StageI = StageI / total_gametes,
    rel_abundance_StageII = StageII / total_gametes,
    rel_abundance_StageIII = StageIII / total_gametes,
    rel_abundance_StageIV = StageIV / total_gametes,
    rel_abundance_StageV = StageV / total_gametes
  )

Rel.Abundance <- Rel.Abundance %>%
  filter(!sex=="NA") %>%
  filter(!treatment=="NA")
```

#Pivot longer for plotting
```{R}
Rel.Abundance_long <- Rel.Abundance %>%
 pivot_longer(cols = starts_with("rel_abundance_Stage"), 
               names_to = "stage", 
               values_to = "value") %>%
  mutate(stage = factor(stage, 
levels = c("rel_abundance_StageI", "rel_abundance_StageII", "rel_abundance_StageIII", "rel_abundance_StageIV", "rel_abundance_StageV"), 
                        labels = c("Stage I", "Stage II", "Stage III", "Stage IV", "Stage V")))

```

# add lines of TP0 for both
#Creating a seperate dataset and plot for the field samples
```{r}
Rel.Abundance_long_field <- Rel.Abundance_long %>%
  filter(treatment=="Field")
 #mutate(date = as.Date(date, format = "%m/%d/%y"))  # Convert date column to Date type for proper ordering
```


# Convert the date column to Date type for proper ordering
```{r}
#Rel.Abundance_long_field <- Rel.Abundance_long_field %>%
  #mutate(date = as.Date(date, format = "%m/%d/%y"))
```

#Reordering dates
```{r}
# Reorder dates and relabel timepoints for field samples
Rel.Abundance_long_field <- Rel.Abundance_long %>%
  filter(treatment == "Field") %>%
  mutate(date = factor(date, 
    levels = c("4/11/21", "4/29/21", "6/4/21", "6/26/21", "7/24/21", "9/2/21"), 
    labels = c("Early April", "Late April", "Early June", "Late June", "July", "September")))




```


```{r}
# Average across all dates for each stage in tank samples
stage_averages_AST_tank <- Rel.Abundance_long_tank %>%
  group_by(sex, timepoint, stage, date, treatment) %>% 
  summarise(
    mean_abundance = mean(value, na.rm = TRUE),
    sd_abundance = sd(value, na.rm = TRUE),
    n = n(),
    se_abundance = sd_abundance / sqrt(n)
  )
```



```{r}
#Rel.Abundance_long_field <- Rel.Abundance_long_field %>%
 # mutate(month = case_when(
   # timepoint == "TP0" ~ "February",
   # timepoint == "TP1" ~ "March",
   # timepoint == "TP2" ~ "Early April",
   # timepoint == "TP3" ~ "Late April",
   # timepoint == "TP4" ~ "May",
    #timepoint == "TP5" ~ "June",
    #timepoint == "TP6" ~ "July",
    #timepoint == "TP7" ~ "August"
 # )) %>%
  #mutate(date = factor(date, levels = c("Early April", "Late April", "Early June", "Late June", "July", "September")))
```

# Create the plot using date for x-axis labels
```{r}
ggplot(Rel.Abundance_long_field, aes(x = date, y = value, fill = stage)) +
  geom_bar(stat = "identity", position = "fill") +
  facet_grid(~ sex) +
  theme_minimal() +
  labs(
    title = "Relative Abundance by Date",
    x = "Date",
    y = "Relative Abundance",
    color = "Stage"
  ) +
  scale_fill_manual(
    values = c("#CCEEF9", "#A6E1F4", "#59C7EB", "#00A9E0", "#137899"),
    labels = c('Stage I', 'Stage II', 'Stage III', 'Stage IV', 'Stage V')
  ) +
  #scale_x_date(date_labels = "%b %d, %Y", date_breaks = "4 day") +
  theme_bw()+
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)
  )

```
#Creating a separate dataset for the experimental data

```{r}
Rel.Abundance_long_tank <- Rel.Abundance_long %>%
  filter(!treatment=="Field")
```


```{r}
# Filtering male data for dates that there is data
male_tank_data <- Rel.Abundance_long_tank %>%
  filter(sex == "male",
         date %in% c("4/2/21", "5/28/21"),
         treatment %in% c("Ambient", "Heat")) %>%
  droplevels()

# Checking sample sizes 
male_tank_data %>%
  count(date, treatment, stage)
```

```{r}
# Check the raw data
data %>%
  filter(sex == "male",
         date %in% c("4/2/21", "5/28/21"),
         treatment %in% c("Ambient", "Heat")) %>%
  count(date, treatment)
```

```{r}
#Plotting experimental
ggplot(Rel.Abundance_long_tank, aes(x = date, y = value, fill = stage)) +
  geom_bar(stat = "identity", position = "fill") +
  facet_grid(sex ~ treatment) +
  theme_minimal() +
  labs(
    title = "Relative Abundance by Timepoint",
    x = "Timepoint",
    y = "Relative Abundance",
    color = "Stage")+
  labs(y = "Relative Proportion (%)", x = "Timepoint", title = "Relative Proportions of Stages") +
  theme_bw() +
  scale_fill_manual(values = c("#CCEEF9", "#A6E1F4", "#59C7EB", "#00A9E0", "#137899"),
                    labels = c( 'Stage I', 'Stage II', 'Stage III', 'Stage IV', 'Stage V'))
```

#Making figure of just TP0

```{r}
Rel.Abundance_long_tank <- Rel.Abundance_long %>%
  filter(!timepoint=="TP2,TP4,TP5,TP6,TP7")

ggplot(Rel.Abundance_long_tank, aes(x = date, y = value, fill = stage)) +
  geom_bar(stat = "identity", position = "fill") +
  facet_grid(sex ~ treatment) +
  theme_minimal() +
  labs(
    title = "Relative Abundance by Timepoint",
    x = "Timepoint",
    y = "Relative Abundance",
    color = "Stage")+
  labs(y = "Relative Proportion (%)", x = "Timepoint", title = "Relative Proportions of Stages") +
  theme_bw() +
  scale_fill_manual(values = c("#CCEEF9", "#A6E1F4", "#59C7EB", "#00A9E0", "#137899"),
                    labels = c( 'Stage I', 'Stage II', 'Stage III', 'Stage IV', 'Stage V'))
```




##Start of the stats
#First just field
```{r}
str(Rel.Abundance_long_field)
head(Rel.Abundance_long_field)
colnames(Rel.Abundance_long_field)

stage_averages <- Rel.Abundance_long_field %>%
  group_by(sex, timepoint, date, stage) %>%
  summarise(mean_abundance = mean(value, na.rm = TRUE),
            sd_abundance = sd(value, na.rm = TRUE),
            n = n(),
            se_abundance = sd_abundance / sqrt(n))
```
#Average across all dates for each stage 
```{r}
stage_averages_AST_field <- Rel.Abundance_long_field %>%
  group_by(sex, timepoint, stage, date) %>%
  summarise(
    mean_abundance = mean(value, na.rm = TRUE)
    #sd_abundance = sd(value, na.rm = TRUE)
    #n = n(),
    #se_abundance = sd_abundance / sqrt(n)
  )
```


```{r}
 #Linear model
lat.mod3 <- lm(mean_abundance ~ sex * stage * timepoint, data = stage_averages_AST_field)
library(car)

# Type III ANOVA
Anova(lat.mod3, type = 3)

```



```{r}
lat.mod3 <- lm(mean_abundance ~ sex * stage * timepoint, data = stage_averages_AST_field)

# Create QQ plot for residuals of the model
qqnorm(residuals(lat.mod3))
qqline(residuals(lat.mod3), col = "red") 


#Next time try response variable not residuals
```


```{r}
# Stage I
model_I <- lm(value ~ sex + date, data = filter(Rel.Abundance_long_field, stage == "Stage I"))
Anova(model_I, type = 3)

# Stage II
model_II <- lm(value ~ sex + date, data = filter(Rel.Abundance_long_field, stage == "Stage II"))
Anova(model_II, type = 3)

# Stage III
model_III <- lm(value ~ sex + date, data = filter(Rel.Abundance_long_field, stage == "Stage III"))
Anova(model_III, type = 3)

# Stage IV
model_IV <- lm(value ~ sex + date, data = filter(Rel.Abundance_long_field, stage == "Stage IV"))
Anova(model_IV, type = 3)

# Stage V
model_V <- lm(value ~ sex + date, data = filter(Rel.Abundance_long_field, stage == "Stage V"))
Anova(model_V, type = 3)
```


#post-hoc test
```{r}
library(emmeans)

# Stage II
model_stageII <- lm(value ~ sex + date, data = filter(Rel.Abundance_long_field, stage == "Stage II"))
emmeans(model_stageII, pairwise ~ date)

# Stage IV
model_stageIV <- lm(value ~ sex + date, data = filter(Rel.Abundance_long_field, stage == "Stage IV"))
emmeans(model_stageIV, pairwise ~ date)
```


#Doing stats for experimental tank samples

```{r}
# Male Tank Data Preparation for Statistical Analysis

# Calculate relative abundances for INDIVIDUAL samples (not grouped)
individual_rel_abundance <- data %>%
  rowwise() %>%
  mutate(
    total_gametes = sum(StageI, StageII, StageIII, StageIV, StageV, na.rm = TRUE),
    rel_abundance_StageI = ifelse(total_gametes > 0, StageI / total_gametes, 0),
    rel_abundance_StageII = ifelse(total_gametes > 0, StageII / total_gametes, 0),
    rel_abundance_StageIII = ifelse(total_gametes > 0, StageIII / total_gametes, 0),
    rel_abundance_StageIV = ifelse(total_gametes > 0, StageIV / total_gametes, 0),
    rel_abundance_StageV = ifelse(total_gametes > 0, StageV / total_gametes, 0)
  ) %>%
  filter(!is.na(sex), !is.na(treatment))

# Pivot longer for individual samples
individual_rel_long <- individual_rel_abundance %>%
  pivot_longer(cols = starts_with("rel_abundance_Stage"), 
               names_to = "stage", 
               values_to = "value") %>%
  mutate(stage = factor(stage, 
                       levels = c("rel_abundance_StageI", "rel_abundance_StageII", 
                                 "rel_abundance_StageIII", "rel_abundance_StageIV", 
                                 "rel_abundance_StageV"), 
                       labels = c("Stage I", "Stage II", "Stage III", "Stage IV", "Stage V")))

# Filter for male tank data (4/2/21 and 5/28/21 dates only)
male_individual_data <- individual_rel_long %>%
  filter(sex == "male",
         date %in% c("4/2/21", "5/28/21"),
         treatment %in% c("Ambient", "Heat"))

# Check sample sizes by individual stage
male_individual_data %>%
  count(date, treatment, stage)

# Pool stages into biologically meaningful groups for statistical analysis
male_pooled <- male_individual_data %>%
  mutate(stage_group = case_when(
    stage %in% c("Stage I", "Stage II") ~ "Early",    # Early stages: gametogenesis stages 1-2
    stage == "Stage III" ~ "Middle",                   # Middle stages: gametogenesis stage 3
    stage %in% c("Stage IV", "Stage V") ~ "Mature"    # Mature stages: gametogenesis stages 4-5
  )) %>%
  group_by(full_sample_id, date, treatment, stage_group) %>%
  summarise(pooled_value = sum(value), .groups = "drop")

# Check sample sizes with pooled stage groups
male_pooled %>%
  count(date, treatment, stage_group)
```




```{r}

# Test Early stages on 5/28/21 (Ambient n=3 vs Heat n=2)
early_late <- male_pooled %>% 
  filter(stage_group == "Early", date == "5/28/21")

# Mann-Whitney U test with exact p-values (recommended for small samples)
wilcox_test(pooled_value ~ treatment, data = early_late, exact = TRUE)

# Alternative - regular wilcox test
wilcox.test(pooled_value ~ treatment, data = early_late, exact = TRUE)
```



# Statistical Analysis for Male Tank Data
# This section analyzes male tank data for two timepoints: 4/2/21 and 5/28/21
```{r}

# Creating individual-level relative abundances (not grouped means)
individual_rel_abundance <- data %>%
  rowwise() %>%
  mutate(
    total_gametes = sum(StageI, StageII, StageIII, StageIV, StageV, na.rm = TRUE),
    rel_abundance_StageI = ifelse(total_gametes > 0, StageI / total_gametes, 0),
    rel_abundance_StageII = ifelse(total_gametes > 0, StageII / total_gametes, 0),
    rel_abundance_StageIII = ifelse(total_gametes > 0, StageIII / total_gametes, 0),
    rel_abundance_StageIV = ifelse(total_gametes > 0, StageIV / total_gametes, 0),
    rel_abundance_StageV = ifelse(total_gametes > 0, StageV / total_gametes, 0)
  ) %>%
  filter(!is.na(sex), !is.na(treatment))

```

```{r}
# Pivot to long format for individual samples
individual_rel_long <- individual_rel_abundance %>%
  pivot_longer(cols = starts_with("rel_abundance_Stage"), 
               names_to = "stage", 
               values_to = "value") %>%
  mutate(stage = factor(stage, 
                       levels = c("rel_abundance_StageI", "rel_abundance_StageII", 
                                 "rel_abundance_StageIII", "rel_abundance_StageIV", 
                                 "rel_abundance_StageV"), 
                       labels = c("Stage I", "Stage II", "Stage III", "Stage IV", "Stage V")))

#  Filter for male tank data (two timepoints only)
male_individual_data <- individual_rel_long %>%
  filter(sex == "male",
         date %in% c("4/2/21", "5/28/21"),
         treatment %in% c("Ambient", "Heat"))
```


```{r}
# Check sample sizes for individual stages
male_individual_data %>%
  count(date, treatment, stage)

# Pool stages into biologically meaningful groups
male_pooled <- male_individual_data %>%
  mutate(stage_group = case_when(
    stage %in% c("Stage I", "Stage II") ~ "Early",    # Stages 1-2 (early development)
    stage == "Stage III" ~ "Middle",                   # Stage 3 (middle development)
    stage %in% c("Stage IV", "Stage V") ~ "Mature"    # Stages 4-5 (mature)
  )) %>%
  group_by(full_sample_id, date, treatment, stage_group) %>%
  summarise(pooled_value = sum(value), .groups = "drop")

# Step 6: Check sample sizes with pooled stages
male_pooled %>% 
  count(date, treatment, stage_group)

```

```{r}
# Statistical Tests

# Only feasible comparison: Early gametogenesis stages on 5/28/21 date (Ambient n=3 vs Heat n=2)
early_stages_may28 <- male_pooled %>% 
  filter(stage_group == "Early", date == "5/28/21")

# Show the data being tested
early_stages_may28

# Separate treatments for Wilcoxon test
ambient_values <- early_stages_may28 %>% 
  filter(treatment == "Ambient") %>% 
  pull(pooled_value)

heat_values <- early_stages_may28 %>% 
  filter(treatment == "Heat") %>% 
  pull(pooled_value)

# Mann-Whitney U test
if(length(ambient_values) > 0 && length(heat_values) > 0) {
  test_result <- wilcox.test(ambient_values, heat_values, exact = TRUE)
  test_result
} else {
  "Cannot perform test - insufficient data"
}

# Descriptive Statistics for all groups
male_descriptive <- male_pooled %>%
  group_by(date, treatment, stage_group) %>%
  summarise(
    n = n(),
    mean = mean(pooled_value, na.rm = TRUE),
    median = median(pooled_value, na.rm = TRUE),
    sd = sd(pooled_value, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(date, stage_group, treatment)

male_descriptive

#  Effect Size (Cohen's d)
if(require(effsize, quietly = TRUE)) {
  if(length(ambient_values) > 0 && length(heat_values) > 0) {
    effect_size <- cohen.d(ambient_values, heat_values)
    effect_size
  }
} else {
  # Manual Cohen's d calculation
  if(length(ambient_values) > 0 && length(heat_values) > 0) {
    mean_diff <- mean(ambient_values) - mean(heat_values)
    pooled_sd <- sqrt(((length(ambient_values)-1)*var(ambient_values) + 
                      (length(heat_values)-1)*var(heat_values)) / 
                     (length(ambient_values) + length(heat_values) - 2))
    cohens_d <- mean_diff / pooled_sd
    paste("Cohen's d:", round(cohens_d, 3))
  }
}

```

# Female abundnance stats
```{r}
library(tidyverse)
library(coin)
```



```{r}

# Creating individual-level relative abundances (not grouped means)
individual_rel_abundance <- data %>%
  rowwise() %>%
  mutate(
    total_gametes = sum(StageI, StageII, StageIII, StageIV, StageV, na.rm = TRUE),
    rel_abundance_StageI = ifelse(total_gametes > 0, StageI / total_gametes, 0),
    rel_abundance_StageII = ifelse(total_gametes > 0, StageII / total_gametes, 0),
    rel_abundance_StageIII = ifelse(total_gametes > 0, StageIII / total_gametes, 0),
    rel_abundance_StageIV = ifelse(total_gametes > 0, StageIV / total_gametes, 0),
    rel_abundance_StageV = ifelse(total_gametes > 0, StageV / total_gametes, 0)
  ) %>%
  ungroup() %>%
  filter(!is.na(sex), !is.na(treatment))
```


```{r}
#Pivoting to long

individual_rel_long <- individual_rel_abundance %>%
  pivot_longer(
    cols = starts_with("rel_abundance_Stage"),
    names_to = "stage",
    values_to = "value"
  ) %>%
  mutate(
    stage = factor(
      stage,
      levels = c(
        "rel_abundance_StageI",
        "rel_abundance_StageII",
        "rel_abundance_StageIII",
        "rel_abundance_StageIV",
        "rel_abundance_StageV"
      ),
      labels = c("Stage I", "Stage II", "Stage III", "Stage IV", "Stage V")
    )
  )
```


```{r}
#Only selecting for females that have both ambient and heated data

female_individual_data <- individual_rel_long %>%
  filter(
    sex == "female",
    treatment %in% c("Ambient", "Heat")
  ) %>%
  group_by(date) %>%
  filter(n_distinct(treatment) == 2) %>%
  ungroup()
```

```{r}
#Pooling stages as early, middle, and mature
female_pooled <- female_individual_data %>%
  mutate(stage_group = case_when(
    stage %in% c("Stage I", "Stage II") ~ "Early",
    stage == "Stage III" ~ "Middle",
    stage %in% c("Stage IV", "Stage V") ~ "Mature"
  )) %>%
  group_by(full_sample_id, date, treatment, stage_group) %>%
  summarise(pooled_value = sum(value), .groups = "drop")
```

```{r}

#descriptive stats

female_effects <- female_pooled %>%
  group_by(date, stage_group) %>%
  summarise(
    n_ambient = sum(treatment == "Ambient"),
    n_heat    = sum(treatment == "Heat"),
    mean_ambient  = mean(pooled_value[treatment == "Ambient"], na.rm = TRUE),
    mean_heat     = mean(pooled_value[treatment == "Heat"], na.rm = TRUE),
    median_ambient = median(pooled_value[treatment == "Ambient"], na.rm = TRUE),
    median_heat    = median(pooled_value[treatment == "Heat"], na.rm = TRUE),
    effect_direction = case_when(
      mean_heat > mean_ambient ~ "Heat > Ambient",
      mean_heat < mean_ambient ~ "Ambient > Heat",
      TRUE ~ NA_character_
    ),
    fold_change = ifelse(mean_ambient > 0, mean_heat / mean_ambient, NA_real_)
  ) %>%
  filter(n_ambient > 0 & n_heat > 0) %>%
  arrange(date, stage_group)


female_effects
```
